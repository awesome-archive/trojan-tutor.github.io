<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"always","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="综述 本文简介 本文总结了自己在VPS搭建Trojan-GFW代理过程中遇到的各种坑，以及最后的解决方案，以供大家参考。 本文的宗旨在于，将大量重复性的工作集中到配置过程中，以让使用过程尽量简单。所以本文的配置过程相较于网上的某些教程稍微复杂一点，但是如果严格按照本文配置过程配置的话，那么配置完成之后服务器端就可以几乎不用搭理他了，然后客户端几乎是拿到手就可以使用，特别适合有好几个人一起共享">
<meta name="keywords" content="VPN,科学上网,代理工具,GFW,翻墙,vps,Ubuntu,Debian,vultr,服务器,Trojan,Trojan-GFW,Trojan-quickstart,https伪装,Nginx,bash,小白教程,搭建教程">
<meta property="og:type" content="article">
<meta property="og:title" content="自建梯子教程 --Trojan版本">
<meta property="og:url" content="https://trojan-tutor.github.io/2019/04/10/p41.html">
<meta property="og:site_name" content="trojan-tutor">
<meta property="og:description" content="综述 本文简介 本文总结了自己在VPS搭建Trojan-GFW代理过程中遇到的各种坑，以及最后的解决方案，以供大家参考。 本文的宗旨在于，将大量重复性的工作集中到配置过程中，以让使用过程尽量简单。所以本文的配置过程相较于网上的某些教程稍微复杂一点，但是如果严格按照本文配置过程配置的话，那么配置完成之后服务器端就可以几乎不用搭理他了，然后客户端几乎是拿到手就可以使用，特别适合有好几个人一起共享">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/工作原理.svg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/Billing.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/addServer.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/chooseServer.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/服务器地点.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/服务器类型.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/服务器大小.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/服务器标签.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/服务器信息.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/检查域名可用性.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/使用期限设置.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/添加网站.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/cf计划.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/导入dns记录.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/freenomMG.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/修改dnsservers.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/DNS配置结果.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/新建会话.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/Xshell.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/证书申请成功提示.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/修改config.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/changeUser.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/etc_nginx_nginx_conf.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/SwitchyOmega选项.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/autoSwitch.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/proxy.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/初始情景模式.jpg">
<meta property="og:image" content="https://trojan-tutor.github.io/2019/04/10/p41/确定状态.jpg">
<meta property="og:updated_time" content="2019-12-28T16:24:50.292Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="自建梯子教程 --Trojan版本">
<meta name="twitter:description" content="综述 本文简介 本文总结了自己在VPS搭建Trojan-GFW代理过程中遇到的各种坑，以及最后的解决方案，以供大家参考。 本文的宗旨在于，将大量重复性的工作集中到配置过程中，以让使用过程尽量简单。所以本文的配置过程相较于网上的某些教程稍微复杂一点，但是如果严格按照本文配置过程配置的话，那么配置完成之后服务器端就可以几乎不用搭理他了，然后客户端几乎是拿到手就可以使用，特别适合有好几个人一起共享">
<meta name="twitter:image" content="https://trojan-tutor.github.io/2019/04/10/p41/工作原理.svg">





  
    <link rel="canonical" href="https://trojan-tutor.github.io/2019/04/10/p41.html">
  
  



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>自建梯子教程 --Trojan版本 | trojan-tutor</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">trojan-tutor</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">trojan-tutor</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    
      
    

    <a href="/archives/index.html" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">2</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
      
    

    
      
    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://trojan-tutor.github.io/2019/04/10/p41.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="trojan-tutor">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="trojan-tutor">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">自建梯子教程 --Trojan版本

              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-10 20:24:09" itemprop="dateCreated datePublished" datetime="2019-04-10T20:24:09+08:00">2019-04-10</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-12-29 00:24:50" itemprop="dateModified" datetime="2019-12-29T00:24:50+08:00">2019-12-29</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/教程/" itemprop="url" rel="index"><span itemprop="name">教程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
                 阅读次数： 
                <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
              </span>
            </span>
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="综述">综述</h3>
<h4 id="本文简介">本文简介</h4>
<p>本文总结了自己在VPS搭建<a href="https://github.com/trojan-gfw/trojan" target="_blank" rel="noopener">Trojan-GFW</a>代理过程中遇到的各种坑，以及最后的解决方案，以供大家参考。</p>
<p>本文的宗旨在于，将大量重复性的工作集中到配置过程中，以让使用过程尽量简单。所以本文的配置过程相较于网上的某些教程稍微复杂一点，但是如果严格按照本文配置过程配置的话，那么配置完成之后服务器端就可以几乎不用搭理他了，然后客户端几乎是拿到手就可以使用，特别适合有好几个人一起共享的情况。</p>
<p>本文将按操作顺序介绍部署用于trojan代理服务的VPS服务器的详细过程，按照步骤操作一切正常的话一小时之内即可配置成功。如果配置过程中有什么疑问，欢迎在留言区交流！</p>
<h4 id="trojan工作原理浅析">Trojan工作原理浅析</h4>
<p>Trojan是一个比较新的翻墙软件，在设计时采用了更适应国情的思路。在穿透GFW时，人们认为强加密和随机混淆可能会欺骗GFW的过滤机制。然而，Trojan实现了这个思路的反面：它模仿了互联网上最常见的HTTPS协议，以诱骗GFW认为它就是HTTPS，从而不被识别。 <img src="p41/工作原理.svg" alt="Trojan工作原理"> 如图所示，Trojan工作在443端口，并且处理来自外界的HTTPS请求，如果是合法的Trojan请求，那么为该请求提供服务，否则将该流量转交给web服务器Nginx，由Nginx为其提供服务。基于这个工作过程可以知道，Trojan的一切表现均与Nginx一致，不会引入额外特征，从而达到无法识别的效果。当然，为了防止恶意探测，我们需要将80端口的流量全部重定向到443端口，并且服务器只暴露80和443端口，这样可以使得服务器与常见的Web服务器表现一致。</p>
<h3 id="前置条件">前置条件</h3>
<p><a name="SystemRequire"></a></p>
<p><strong><em>系统要求：<a href="https://ubuntu.com" target="_blank" rel="noopener">Ubuntu</a> &gt;= 16.04</em></strong> or <strong><em><a href="https://www.debian.org" target="_blank" rel="noopener">Debian</a> &gt;= 9</em></strong> or <strong><em><a href="https://centos.org" target="_blank" rel="noopener">CentOS</a> &gt;= 7</em></strong>。</p>
<h3 id="vps服务器购买">VPS服务器购买</h3>
<h4 id="注册vultr">注册vultr</h4>
<p>我使用的服务器是vultr。主要因为其按小时计费，随时可以停用服务器。这一点很重要，现在gfw相当高，所以你买到的机器很可能是已经被墙了的。其次，vultr本身没有被墙，这一点很重要，不然就是先有鸡还是先有蛋的问题了。当然，可以支付宝或微信付款也是一个加分点。vultr充值10美元送10美元活动注册地址：<a href="https://www.vultr.com/?ref=7241747" target="_blank" rel="noopener">https://www.vultr.com</a>。点击链接跳转到vultr，网页右上角有个Create Account就是注册的地方了，接下来就是注册并激活账号了。</p>
<p><strong><em>最新资讯：vultr充值10美元送50美元活动开始啦，必须是新用户，可支付宝或微信等支付方式，活动注册地址：<a href="https://www.vultr.com/?ref=7792804-4F" target="_blank" rel="noopener">https://www.vultr.com</a>！</em></strong></p>
<h4 id="充值">充值</h4>
<p>在购买服务器之前需要先充值。登陆vultr之后如图Billing-&gt;Alipay，选好要充值的金额数，然后Pay with Alipay即可跳转到支付宝扫码支付页面。 <img src="p41/Billing.jpg" alt="Billing"></p>
<h4 id="购买服务器">购买服务器</h4>
<p>点击vultr网页右上角的蓝色+图标即可为账户添加服务器。 <img src="p41/addServer.jpg" alt="addServer"></p>
<p><strong>注意</strong>：向下滚动有很多选项，不要直接点击Deploy Now，这样会使用默认参数，但不是我们想要的！ 第一个选项为选择服务器类型（Choose Server），这里选择Cloud Compute。 <img src="p41/chooseServer.jpg" alt="服务器类型，选择Cloud Compute"></p>
<p>第二个选项为选择服务器地址（Server Location），建议选择硅谷（Silicon Valley，离google最近），而不要选择日本（用的人多，大部分IP已经被墙）； <img src="p41/服务器地点.jpg" alt="服务器地点"></p>
<p>第三个选项为选择服务器类型（Server Type），即选择服务器操作系统。作为示例，这里我们选择选择<strong><em>Ubuntu 18.10 x64（强烈推荐）</em></strong>，不过<a href="#SystemRequire">系统要求</a>部分所列出的操作系统均已测试通过，同一个发行版本的系统在我要求以下的版本测试不通过。注意如果你使用其他vps服务商的vps，可能有minimal选项，不能选择那一个，很多依赖乃没有安装，会导致自己配置失败（当然也可以，缺少哪个依赖自己再用apt安装就好了，例如：<code>apt install -y sudo</code>，<code>sudo apt install -y vim</code>等）。最后，如果你确实是有其他系统或者比较旧的系统版本需要安装trojan的话，建议使用docker，正文中部分配置只需要做细微修改即可，为了文章的整体性我就不放在正文了，请<a href="https://github.com/trojan-tutor/trojan-tutor.github.io/issues/1" target="_blank" rel="noopener">参考评论区</a>。 <img src="p41/服务器类型.jpg" alt="服务器类型"></p>
<p>第四个选项为选择服务器大小（Server Size），即选择服务器硬件性能。因为我们使用VPS服务器翻墙，所以性能瓶颈不在配置，而在网络带宽之类的。由于vultr的服务器带宽都是100M的，所以服务器当然是往便宜了选。当然，<code>$2.5/mo</code>的一般都是缺货的。选择<code>$5/mo</code>的就好，一个月三十几块钱，要是有好几个人一起分担的话就相当实惠了。 <img src="p41/服务器大小.jpg" alt="服务器大小"></p>
<p>第五、六、七三个选项可以不用管它。</p>
<p>第八条要求为即将部署的服务器命名并给一个标签，随意就好。</p>
<p>此时可以点击右下角的现在部署（Deploy Now），vultr即开始分配资源，安装系统。此时Servers页面可以看到服务器信息，状态显示installing。当状态切换为Running的时候，服务器就可以使用了。 <img src="p41/服务器标签.jpg" alt="服务器标签"></p>
<h4 id="服务器信息查看">服务器信息查看</h4>
<p>服务器安装结束之后在Servers页面点击刚才购买的服务器名字即可跳转到服务器详情页。如图右上角有一个View console可以直接通过网页连接到服务器，但是由于它不支持复制粘贴，不方便，我们需要使用第三方工具连接到服务器。所以需要知道IP、用户名和密码，如图左下角。 <img src="p41/服务器信息.jpg" alt="服务器信息"></p>
<h3 id="域名申请与解析">域名申请与解析</h3>
<p>trojan需要一个域名用来做伪装，所以需要先申请一个域名。如果你只是用来翻墙没有其他作用，那么建议注册一个免费域名即可。本教程使用freenom免费域名和cloudflareDNS为例。</p>
<p><a name="domain"></a></p>
<p>如果自己已经有域名了那么可以不用申请，直接用一个子域名就可以了。如果你的域名不是在cloudflare购买，那么你有两个方案可用。1. 将你的域名转移到cloudflare解析，这个对于已经有域名的来说应该不难，就不多说了；2. 下文与cloudflare相关的部分自行参考<a href="https://github.com/Neilpang/acme.sh/wiki/dnsapi" target="_blank" rel="noopener">这个文档</a>做调整，也很简单，找到你自己的DNS服务商，按照指引操作即可。建议是先严格按照教程操作成功之后再改为自己的域名，否则难免出奇怪的问题。</p>
<h4 id="freenom免费域名申请">freenom免费域名申请</h4>
<p><strong><em>我自己在使用Edge注册freenom的时候会失败，使用<a href="https://www.google.cn/chrome/" target="_blank" rel="noopener">chrome</a>才可以，你如果也失败了请换一个浏览器试试！</em></strong></p>
<p><strong><em>freenom在检测到ip对应的国家和你填写的个人信息不一致就会不允许你注册，所以要么不要挂VPN去申请域名，要么去网上生成虚拟美国人信息。</em></strong></p>
<p>freenom注册地址在这里<a href="https://www.freenom.com" class="uri" target="_blank" rel="noopener">https://www.freenom.com</a>，支持简体中文，可以自行切换。在寻找一个免费域名的输入框中输入自己理想的域名点击检查可用性，如图所示。检查到可用的中意的域名之后，点击现在获取即可锁定该域名。 <img src="p41/检查域名可用性.jpg" alt="检查域名可用性"></p>
<p>现在可以点击完成按钮跳转到DNS配置和申请年限界面。点击Use DNS&gt;&gt;Use Frenom DNS Service。两个IP address框都直接输入0.0.0.0（这个没用，一会儿会改到cloudflareDNS）。Period选择12 Months @ FREE，然后点击Continue，输入并验证你的邮箱和信息即可。<strong><em>注意上面的提示，不要挂VPN，很多人会卡在验证账户的地方，一般都是挂了VPN导致的。</em></strong></p>
<p>在freenom申请的免费域名是可以无限免费续期的，除非被人花钱抢注，所以自己每隔几个月回来续期一下就可以啦。反正这个域名只是拿来翻墙用，被人抢注了马上换一个成本也不大。如果介意这个的话，建议自己买付费域名，国外域名服务商推荐<a href="https://namecheap.com" target="_blank" rel="noopener">namecheap</a>，<strong><em>不要买国内域名服务商的域名</em></strong>。 <img src="p41/使用期限设置.jpg" alt="使用期限设置"></p>
<h4 id="注册cloudflare">注册cloudflare</h4>
<p>cloudflare注册地址在这里<a href="https://www.cloudflare.com" class="uri" target="_blank" rel="noopener">https://www.cloudflare.com</a>，网页右上角有个Sign up就是注册的地方了，接下来就是注册并激活账号了。注册完成之后会让你添加你的网站，输入你刚才申请的网站之后点击Add site。 <img src="p41/添加网站.jpg" alt="添加网站"></p>
<p>接下来是一个提示页面，直接下一步即可。然后计划选择FREE就好，够用了，然后点击confirm plan。 <img src="p41/cf计划.jpg" alt="cf计划"></p>
<p>然后cloudflare会导入现有的DNS记录，你也可以自己再添加，也可以在这里修改，现在需要将DNS记录指向自己的服务器。假设你的服务器地址是10.10.10.10，那么如下图所示：将域名A记录指向你的服务器即可，www的A记录删除不用。如果IP地址是IPv6的，那么需要添加的是AAAA记录而不是A记录（客户端也得有IPv6地址才能连接上服务器）。vultr的服务器是IPv4和IPv6地址都有的，可以即添加A记录又添加AAAA记录，客户端会自动选择他将会使用的IP地址版本。添加好记录之后，点击continue。<strong><em>注意：不能使用CDN（On Cloudflare），即DNS记录后面的云需要是灰色的而不是橙色的，否则会导致握手失败无法连接上服务器，参考<a href="https://github.com/trojan-gfw/trojan/issues/70" target="_blank" rel="noopener">trojan issue 70</a></em></strong> <img src="p41/导入dns记录.jpg" alt="导入dns记录"></p>
<p>接下来就是最关键的一步，将你的DNS服务器转移到cloudflare。在这里你可以看到cloudflare让你将ns01.freenom.com和ns02.freenom.com分别改为anna.ns.cloudflare.com和sid.ns.cloudflare.com（每个人的可能不会一样，请按照cloudflare的提示）。</p>
<p>现在登陆<a href="https://my.freenom.com" target="_blank" rel="noopener">freenom</a>，点击域名后面对应的Manage Domain。 <img src="p41/freenomMG.jpg" alt="freenomMG"></p>
<p>然后定位到Management Tools&gt;&gt;Nameservers。将DNS服务器改为Use custom nameservers (enter below)，然后在Nameserver 1和Nameserver 2输入cloudflare给的两个dns，如图所示，点击change Nameservers即可。然后回到cloudflare点击Continue。 <img src="p41/修改dnsservers.jpg" alt="修改dnsservers"></p>
<p>此时cloudflare会检测你的dns服务器是否已经切换到了cloudflare，如果没有检测到已经切换的话，稍作等待即可。最终，DNS配置结果如下图所示，即 <img src="p41/DNS配置结果.jpg" alt="DNS配置结果"></p>
<h3 id="vps服务器部署">VPS服务器部署</h3>
<p><strong><em>跳过了上面系统选择与购买部分的要注意啦，本教程目前<a href="#SystemRequire">测试通过</a>操作系统版本是Ubuntu 16.04 or Debian 9 or CentOS 7及以上，更低版本系统无法成功搭建，其他系统尚未测试！</em></strong></p>
<p><strong><em>跳过了上面系统选择与购买部分的要注意啦，本教程目前<a href="#SystemRequire">测试通过</a>操作系统版本是Ubuntu 16.04 or Debian 9 or CentOS 7及以上，更低版本系统无法成功搭建，其他系统尚未测试！</em></strong></p>
<p><strong><em>跳过了上面系统选择与购买部分的要注意啦，本教程目前<a href="#SystemRequire">测试通过</a>操作系统版本是Ubuntu 16.04 or Debian 9 or CentOS 7及以上，更低版本系统无法成功搭建，其他系统尚未测试！</em></strong></p>
<h4 id="远程工具安装">远程工具安装</h4>
<p>本文使用的第三方远程管理工具叫做<a href="https://www.netsarang.com/products/xsh_overview.html" target="_blank" rel="noopener">Xshell</a>。Xshell学生和家庭版是免费的，可以放心试用（<strong><em>觉得好用的话，不差钱的各位也可以注册一下支持软件开发者噢</em></strong>）。安装好Xshell之后即可开始连接服务器进行部署了。不过Xshell没有Mac端，所以Mac可以使用其他ssh客户端，甚至直接用终端都可以，用法大同小异。</p>
<h4 id="连接服务器">连接服务器</h4>
<p>启动Xshell，从菜单栏的文件-&gt;新建打开新建会话窗口如下图。会话名称随便取一个都可以，主机填写刚才记下来的服务器IP地址或者直接填域名也是可以的。点击确定立即尝试连接服务器，如果能连接上服务器会提示输入用户名和密码。用户名为<code>root</code>，密码可以从vultr服务器详情页拷贝过来。可以记住用户名和密码，这样下次连接就不用再输入那个复杂的密码了（当然密码是可以修改的，但是没必要。系统自动生成的密码强度相当高，可以避免暴力破解。自己设的密码就不好说了，而且还容易忘记）。 <img src="p41/新建会话.jpg" alt="新建会话"></p>
<p>连接成功之后会出现命令提示符：<code>root@username:~#</code>。 <img src="p41/Xshell.jpg" alt="新建会话"></p>
<p>连接上服务器后就可以开始安装Trojan了。对于Xshell连不上服务器的情况，如果是使用域名连接的话，先<a href="http://ping.chinaz.com/" target="_blank" rel="noopener">ping</a>一下域名看看是否DNS解析尚未生效，如果尚未生效，那么需要等一下，在等待的过程中可以先用IP将服务器配置好。如果<a href="http://ping.chinaz.com/" target="_blank" rel="noopener">ping</a>不通IP的话，那么多半是被墙了，那就只能换掉服务器了。（<strong>血的教训</strong>：先购买新服务器，再去vultr服务器页面Destroy。反过来的话间隔太小，估计又买到原来的ip了。或者直接开个四五台服务器，然后保留<a href="http://ping.chinaz.com/" target="_blank" rel="noopener">ping</a>结果最好的，删除其余的就好了。）</p>
<h4 id="创建用户账户可选">创建用户账户（可选）</h4>
<p><a name="createuser"></a></p>
<p>为了系统安全，一般不建议直接使用<code>root</code>用户对系统做设置，而vultr默认只有<code>root</code>用户，故可以自己新建一个非<code>root</code>但是有<code>sudo</code>权限的用户继续后面的操作，代码如下所示，注意密码强度不能太低。第一条命令创建用户，第二条命令设置密码，第三条命令将该用户加入<code>sudo</code>组，第四条命令切换到该用户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m -s /bin/bash trojanuser</span><br><span class="line">sudo passwd trojanuser</span><br><span class="line">sudo usermod -G sudo trojanuser</span><br><span class="line">su -l trojanuser</span><br></pre></td></tr></table></figure>
<h4 id="创建服务账户">创建服务账户</h4>
<p>很多看教程的小伙伴问“为什么非要弄这么多用户，直接root不可以吗？”，这里简单回答一下。既然Trojan是占用443端口，使用https协议，所以必然是要安装证书的。本教程使用<a href="https://github.com/Neilpang/acme.sh" target="_blank" rel="noopener">acme.sh</a>为Trojan生成证书，并配置了acme.sh的自动更新，包括代码和证书的更新。一方面，既然有配置自动更新就有可能出各种问题，毕竟你对更新之后的代码和证书是否可用一无所知。另一方面，acme.sh和Trojan均为开源软件，不一定值得信赖。基于此，为了降低acme.sh和Trojan对系统的影响和其相互影响，故需要单独为acme.sh和Trojan建立没有<code>sudo</code>权限的用户。如果执意使用具有<code>sudo</code>权限的用户，或者头铁直接使用<code>root</code>，出了问题是要自己承担责任的。</p>
<p>这里我们创建两个用户，分别为<code>trojan</code>和<code>acme</code>。其中用户<code>trojan</code>只需要运行<code>trojan</code>服务，无需登录，也无需家目录，故设置为系统用户即可。这里将用户<code>acme</code>也设置为系统用户，但是区别在于<code>acme</code>需要配置acme.sh，故需要家目录。注意到，我并未给用户<code>acme</code>设置密码，所以该用户也不能登录，只能通过其他已经登录的用户切换过去，这样尽可能的保证了系统的安全与任务的独立。因为<code>trojan</code>和<code>acme</code>都需要读写证书文件，所以将<code>acme</code>和<code>trojan</code>添加到同一个用户组<code>certusers</code>，待申请到证书后将证书所有权交给用户组<code>certusers</code>并允许组内用户访问即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd certusers</span><br><span class="line">sudo useradd -r -M -G certusers trojan</span><br><span class="line">sudo useradd -r -m -G certusers acme</span><br></pre></td></tr></table></figure>
<h4 id="安装依赖">安装依赖</h4>
<p>由于Debian系列系统和CentOS系列系统使用不同的包管理软件，所以安装软件的命令不一样，下面两个小节自己对照自己系统选择命令。</p>
<h5 id="ubuntu-or-debian">Ubuntu or Debian</h5>
<p>更新源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt upgrade -y</span><br></pre></td></tr></table></figure>
<p>安装acme.sh需要的依赖。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y socat cron curl</span><br></pre></td></tr></table></figure>
<p>启动crontab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start cron</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> cron</span><br></pre></td></tr></table></figure>
<p>安装Trojan需要的依赖。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y libcap2-bin xz-utils nano</span><br></pre></td></tr></table></figure>
<p>安装Nginx。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y nginx</span><br></pre></td></tr></table></figure>
<h5 id="centos">CentOS</h5>
<p>安装acme.sh需要的依赖。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y socat cronie curl</span><br></pre></td></tr></table></figure>
<p>启动crontab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start crond</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> crond</span><br></pre></td></tr></table></figure>
<p>安装Trojan需要的依赖。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y xz nano</span><br></pre></td></tr></table></figure>
<p>安装Nginx。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y nginx</span><br></pre></td></tr></table></figure>
<h4 id="创建证书文件夹">创建证书文件夹</h4>
<p>第一条命令新建一个文件夹<code>/usr/local/etc/certfiles</code>用于存放证书。第二条命令将证书文件夹所有者改为<code>acme</code>，使得用户<code>acme</code>有权限写入证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/etc/certfiles</span><br><span class="line">sudo chown -R acme:acme /usr/<span class="built_in">local</span>/etc/certfiles</span><br></pre></td></tr></table></figure>
<h4 id="配置证书">配置证书</h4>
<h5 id="安装acme.sh自动管理ca证书脚本">安装acme.sh自动管理CA证书脚本</h5>
<p><strong><em>分别</em></strong>执行如下命令，注意看是否报错。第一条命令切换到用户<code>acme</code>。第二条命令安装acme.sh。第三条命令退出当前用户。第四条命令再次切换到用户<code>acme</code>。注意到这里两次切换用户的操作不能省略，因为安装完acme.sh之后要重新登录当前用户，否则无法识别出acme.sh命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su -l -s /bin/bash acme</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl  https://get.acme.sh | sh</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su -l -s /bin/bash acme</span><br></pre></td></tr></table></figure>
<h5 id="添加cloudflare-global-ca-key">添加cloudflare Global CA Key</h5>
<p><strong><em>不是使用cloudflare DNS的请查看<a href="#domain">域名申请与解析</a>部分自己做调整！</em></strong></p>
<p>需要让acme.sh自动管理你的证书，所以需要添加cloudflare的API。登录cloudflare之后定位到：头像&gt;&gt;My Profile&gt;&gt;API Tokens。可以看到这里有两个API Keys。我们需要的是Global API Key。Origin CA Key是不可以使用的。点击View即可查看，注意查看之后自己保存下来，每天可查看次数是有限制的。</p>
<p>然后在Xshell里面执行如下两条命令，注意执行成功没有提示，所以自己不要输错了。其中引号内的内容改为你自己的。<strong><em>注意，本文中代码需要手动修改的地方都使用<code>&lt;&gt;</code>包裹。</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CF_Key=<span class="string">"&lt;Your Global API Key&gt;"</span></span><br><span class="line"><span class="built_in">export</span> CF_Email=<span class="string">"&lt;Your cloudflare account Email&gt;"</span></span><br></pre></td></tr></table></figure>
<h5 id="申请证书">申请证书</h5>
<p><strong><em>不是使用cloudflare DNS的请查看<a href="#domain">域名申请与解析</a>部分自己做调整！</em></strong></p>
<p>执行如下命令（<strong><em>注意域名<code>&lt;tdom.ml&gt;</code>改为你自己的域名</em></strong>），等待一会儿。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --issue --dns dns_cf -d &lt;tdom.ml&gt;</span><br></pre></td></tr></table></figure></p>
<p>看到下图的提示表示证书申请成功。 <img src="p41/证书申请成功提示.jpg" alt="证书申请成功提示"></p>
<p><strong><em>申请失败怎么办？</em></strong>证书申请失败的可能性一般有：1. CF_Key或CF_Email填写错误；证书申请次数超限等。此时<strong><em>切忌反复尝试</em></strong>，原因是证书每一个周申请次数是有限制的（20次），如果超限了就需要等一个周或者更换域名了（这个限制是争对每一个子域单独做的限制，所以万一超限了还可以用子域名继续部署）。解决方案是：在上述命令后加<code>--staging</code>参数继续测试。测试通过之后，删除上图所示四个证书文件并<strong><em>取消<code>--staging</code>参数</em></strong>再执行一次。<code>--staging</code>参数申请的证书只作为测试用，客户端是无法认证通过的（提示<code>SSL handshake failed: tlsv1 alert unknown ca</code>），所以使用<code>--staging</code>参数申请到了证书之后要去掉<code>--staging</code>参数重新申请一次。</p>
<h5 id="安装证书">安装证书</h5>
<p>执行如下命令（<strong><em>注意域名<code>&lt;tdom.ml&gt;</code>改为你自己的域名</em></strong>），第一条命令使用acme.sh将证书安装到<code>certfiles</code>目录，这样acme.sh更新证书的时候会自动将新的证书安装到这里。第二条命令是配置acme.sh自动更新和自动更新证书，这样配置完Trojan之后一般不用管服务器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d &lt;tdom.ml&gt; --key-file /usr/<span class="built_in">local</span>/etc/certfiles/private.key --fullchain-file /usr/<span class="built_in">local</span>/etc/certfiles/certificate.crt</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh  --upgrade  --auto-upgrade</span><br></pre></td></tr></table></figure>
<h5 id="修改权限">修改权限</h5>
<p>最后还要允许组内用户访问证书。可通过如下命令实现。第一条命令将证书文件夹所在用户组改为<code>certusers</code>。第二条命令是赋予证书文件夹组内用户读取权限。运行这两条命令之后用户<code>trojan</code>就有权限读取证书了。第三条命令退出用户<code>acme</code>，因为证书已经安装完成。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R acme:certusers /usr/<span class="built_in">local</span>/etc/certfiles</span><br><span class="line">chmod -R 750 /usr/<span class="built_in">local</span>/etc/certfiles</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="配置trojan">配置Trojan</h4>
<h5 id="安装trojan">安装Trojan</h5>
<p>分别执行如下四个命令，注意看是否报错。第一个命令是安装Trojan，安装完成一般会提示版本号注意看是否是最新版本。第二个命令是将Trojan配置文件的所有者修改为用户<code>trojan</code>，由于使用<code>sudo</code>安装的Trojan，该配置文件默认是属于<code>root</code>用户的，而我们需要使用用户<code>trojan</code>运行Trojan，不修改所有者会导致启动Trojan遇到权限问题。第三个命令备份Trojan配置文件，以防万一。第四个命令是使用nano修改配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/trojan-gfw/trojan-quickstart/master/trojan-quickstart.sh)</span>"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R trojan:trojan /usr/<span class="built_in">local</span>/etc/trojan</span><br><span class="line">sudo cp /usr/<span class="built_in">local</span>/etc/trojan/config.json /usr/<span class="built_in">local</span>/etc/trojan/config.json.bak</span><br><span class="line">sudo nano /usr/<span class="built_in">local</span>/etc/trojan/config.json</span><br></pre></td></tr></table></figure>
<p>第四个命令执行完之后屏幕会显示Trojan的配置文件，定位到<code>password</code>、<code>cert</code>和<code>key</code>并修改。密码按自己喜好，<code>cert</code>和<code>key</code>分别改为<code>/usr/local/etc/certfiles/certificate.crt</code>和<code>/usr/local/etc/certfiles/private.key</code>。编辑完成配置文件之后按屏幕下方快捷键提示（<code>^O</code>和<code>^X</code>即：<code>Ctrl+O</code>和<code>Ctrl+X</code>）保存并退出nano。修改之后的config文件如图所示。另外，如果有<code>IPv6</code>地址，将<code>local_addr</code>的<code>0.0.0.0</code>改为<code>::</code>才可以使用。 <img src="p41/修改config.jpg" alt="修改config"></p>
<h5 id="启动trojan">启动Trojan</h5>
<h6 id="修改trojan启动用户">修改Trojan启动用户</h6>
<p>执行如下命令，打开<code>trojan.service</code>文件，并将用户修改为<code>trojan</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/trojan.service</span><br></pre></td></tr></table></figure>
<p>添加用户效果如图所示，注意等号旁边没有空格。 <img src="p41/changeUser.jpg" alt="添加trojan用户到trojan.service"></p>
<p>然后重新加载配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>
<h6 id="赋予trojan监听443端口能力">赋予Trojan监听443端口能力</h6>
<p>执行如下命令，赋予Trojan监听1024以下端口的能力，使得Trojan可以监听到443端口。这是由于我们使用非<code>root</code>用户启动Trojan，但是Linux默认不允许非<code>root</code>用户启动的进程监听1024以下的端口，除非为每一个二进制文件显式声明。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">setcap</span> CAP_NET_BIND_SERVICE=+eip /usr/<span class="built_in">local</span>/bin/trojan</span><br></pre></td></tr></table></figure>
<h6 id="使用systemd启动trojan">使用systemd启动Trojan</h6>
<p>Trojan启动、查看状态命令分别如下，第一条是启动Trojan，第二条是查看Trojan运行状态。启动之后再查看一下状态，Trojan显示active (running)即表示正常启动了。如果出现<code>fatal: config.json(n): invalid code sequence</code>错误，那么是你的配置文件第<code>n</code>行有错误，请检查。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart trojan</span><br><span class="line">sudo systemctl status trojan</span><br></pre></td></tr></table></figure>
<h5 id="更新证书">更新证书</h5>
<p>当acme.sh重新安装证书之后，需要通知Trojan重新加载证书。最简单的方案是每三个月登录服务器重启Trojan，但是不够完美，毕竟重启的时候会导致服务中断。其实Trojan有实现<a href="https://github.com/trojan-gfw/trojan/commit/53ca5f80fcd6239c28c8520886692e9186e3fcf6" target="_blank" rel="noopener">reload certificate and private key</a>功能，只需要在证书更新后给Trojan发送<code>SIGUSR1</code>消息即可。Trojan收到<code>SIGUSR1</code>消息后便会自动加载新的证书和密钥文件，这样就不用重启Trojan了。手动给Trojan发送<code>SIGUSR1</code>消息的命令是<code>sudo -u trojan killall -s SIGUSR1 trojan</code>，但是这样也不够完美，也得每三个月登录服务器运行一次该命令。其实我们可以给用户<code>trojan</code>添加定时任务，使其每个月运行一次该命令即可。实现如下。</p>
<p>首先，编辑用户<code>trojan</code>的crontab文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u trojan crontab -e</span><br></pre></td></tr></table></figure>
<p>在文件末尾添加一行如下，该行表示每个月1号的时候运行命令<code>killall -s SIGUSR1 trojan</code>，由于是使用用户<code>trojan</code>运行的，故不需要在前面加<code>sudo -u trojan</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * killall -s SIGUSR1 trojan</span><br></pre></td></tr></table></figure>
<p>最后查看crontab是否生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u trojan crontab -l</span><br></pre></td></tr></table></figure>
<h5 id="更新trojan">更新Trojan</h5>
<p>如果Trojan版本有更新（可以去<a href="https://github.com/trojan-gfw/trojan/releases" target="_blank" rel="noopener">这里</a>查看是否有更新），那么使用本教程搭建的服务器端更新Trojan版本只需要三条命令即可，不过要注意的是，第一条命令会提示是否覆盖配置文件，如果没有必要请回答n，否则配置文件将会被覆盖（如果不小心覆盖了就得自己重新编辑了）。第二条命令重新赋予Trojan监听443端口的能力。第三条命令重启Trojan。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/trojan-gfw/trojan-quickstart/master/trojan-quickstart.sh)</span>"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">setcap</span> CAP_NET_BIND_SERVICE=+eip /usr/<span class="built_in">local</span>/bin/trojan</span><br><span class="line">sudo systemctl restart trojan</span><br></pre></td></tr></table></figure>
<h4 id="配置nginx">配置Nginx</h4>
<h5 id="写入虚拟主机到nginx配置文件">写入虚拟主机到Nginx配置文件</h5>
<p><a name="nginxconfig"></a></p>
<p>由于Nginx配置在Debian系列系统和CentOS系列系统组织方式不同，所以配置文件位置和使用方式有细微区别，为了统一，我将CentOS系列系统的组织结构做细微调整。</p>
<p>在Debian系列系统中，Nginx的虚拟主机配置文件在<code>/etc/nginx/sites-available/</code>文件夹中，如果要开启某一个虚拟主机，则建立一个软连接到<code>/etc/nginx/sites-enabled/</code>文件夹并重启Nginx即可。默认虚拟主机在<code>/etc/nginx/sites-enabled/</code>文件夹，需要关闭掉，否则会冲突。</p>
<p>在CentOS系列系统中，Nginx的虚拟主机配置文件在<code>/etc/nginx/conf.d/</code>文件夹中以<code>.conf</code>后缀保存，写入之后就可以使用。默认虚拟主机集成在Nginx配置文件<code>/etc/nginx/nginx.conf</code>中，需要打开将其中的server块删除，否则会冲突。Debian系列系统中的<code>/etc/nginx/sites-enabled/</code>和<code>/etc/nginx/sites-available/</code>文件夹结构在CentOS系列系统中是没有的，不过这个策略很不错，可以很方便的开启和关闭虚拟主机，我这里手动调整一下。</p>
<h6 id="centos-1">CentOS</h6>
<p>按上述分析，我们使用下面两条命令在<code>/etc/nginx/</code>中添加两个文件夹。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /etc/nginx/sites-available</span><br><span class="line">sudo mkdir /etc/nginx/sites-enabled</span><br></pre></td></tr></table></figure>
<p>执行如下命令使用nano打开Nginx配置文件，删除其中server块，并添加对<code>/etc/nginx/sites-enabled/</code>文件夹的索引。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>
<p>配置文件修改结果如下图所示。 <img src="p41/etc_nginx_nginx_conf.jpg" alt="etc_nginx_nginx_conf"></p>
<p>CentOS反向代理需要配置SELinux允许httpd模块可以联网，否则服务器会返回502错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo setsebool -P httpd_can_network_connect <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h6 id="ubuntu-or-debian-1">Ubuntu or Debian</h6>
<p>使用如下命令关闭Nginx默认虚拟主机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /etc/nginx/sites-enabled/default</span><br></pre></td></tr></table></figure>
<h6 id="写入配置">写入配置</h6>
<p>1.执行如下命令，使用<code>nano</code>添加虚拟主机。(<strong><em>注意域名<code>&lt;tdom.ml&gt;</code>改为你自己的域名，这是虚拟主机的文件名，只是用来自己识别的。如果你已经有配置虚拟主机在这个文件中，可以自己使用<code>cp</code>命令备份一下或者换个名字也行，等介绍完基本配置再讲如何与现有服务集成。</em></strong>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/nginx/sites-available/&lt;tdom.ml&gt;</span><br></pre></td></tr></table></figure>
<p>基于综述部分讲解的Trojan工作原理，现给定Nginx虚拟主机如下所示。这些虚拟主机可以直接拷贝到上面虚拟主机配置文件中再修改为你自己的，其中要修改的地方包括：</p>
<ol type="1">
<li>第4行的<code>server_name</code>的值<code>&lt;tdom.ml&gt;</code>改为你自己的域名；</li>
<li>第7行的<code>proxy_pass</code>随便指向一个没有敏感信息的网站都可以，这就是你要反向代理的网站，这里我是用了RFC文档的地址；</li>
<li>第15行的<code>server_name</code>的值<code>&lt;10.10.10.10&gt;</code>改为你自己的IP；</li>
<li>第17行<code>&lt;tdom.ml&gt;</code>改为自己的域名，注意别填错了。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 127.0.0.1:80 default_server;</span><br><span class="line"></span><br><span class="line">    server_name &lt;tdom.ml&gt;;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass https://www.ietf.org;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 127.0.0.1:80;</span><br><span class="line"></span><br><span class="line">    server_name &lt;10.10.10.10&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 301 https://&lt;tdom.ml&gt;<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 0.0.0.0:80;</span><br><span class="line">    listen [::]:80;</span><br><span class="line"></span><br><span class="line">    server_name _;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释一下这些虚拟主机的一些细节：第一个server接收来自Trojan的流量，与上面Trojan配置文件对应；第二个server也是接收来自Trojan的流量，但是这个流量尝试使用IP而不是域名访问服务器，所以将其认为是异常流量，并重定向到域名；第三个server接收除127.0.0.1:80外的所有80端口的流量并重定向到443端口，这样便开启了全站https，可有效的防止恶意探测。注意到，第一个和第二个server对应综述部分原理图中的蓝色数据流，第三个server对应综述部分原理图中的红色数据流，综述部分原理图中的绿色数据流不会流到Nginx。</p>
<p>2.使能配置文件<strong><em>注意域名<code>&lt;tdom.ml&gt;</code>改为你自己的域名</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /etc/nginx/sites-available/&lt;tdom.ml&gt; /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure>
<h5 id="启动nginx">启动Nginx</h5>
<p>Nginx启动命令和Trojan一样，就不过多解释了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br><span class="line">sudo systemctl status nginx</span><br></pre></td></tr></table></figure>
<h5 id="与现有nginx服务集成">与现有Nginx服务集成</h5>
<p>如果你本机已经有Nginx服务，那么Nginx配置文件需要做适当修改以和现有服务兼容。</p>
<ol type="1">
<li><p>在原服务与Trojan使用同一个域名且原来是监听443端口的情况下，那么需要将你的ssl配置删除并将监听地址改为第一个server监听的地址127.0.0.1:80，然后直接用修改好的server代替上述配置文件中第一个server即可。这样https加密部分将会由Trojan处理之后转发给Nginx而不是由Nginx处理，原来的服务对于客户端来说就没有变化。</p></li>
<li><p>如果原来的服务与Trojan使用不同的域名，建议是修改Trojan与原来的服务使用同一个域名，如果非要使用不同的域名，请参考第3点。</p></li>
<li><p>如果原来的服务就监听了多个域名，那么请自己琢磨Nginx的sni，参考连接：<a href="https://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html" target="_blank" rel="noopener">ngx_stream_ssl_preread_module</a>。</p></li>
<li><p>如果原来的服务是监听80端口，想要继续监听80端口那么直接去除第三个server即可，如果要改为监听443端口参考第1点。</p></li>
</ol>
<h4 id="配置trojan和nginx开机自启">配置Trojan和Nginx开机自启</h4>
<p>虽然开机自启一般用不着，除非vultr机房停电，但是反正也没什么代价，弄一下吧。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> trojan</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>
<h4 id="检查服务器是否配置成功">检查服务器是否配置成功</h4>
<p>到这里服务器就配置完成了。此时你可以在浏览器里面访问你的网站看是否能够访问，如果你的网站可以访问了，那么就一切正常啦。</p>
<p>另外，基于以上考虑到的可能的恶意探测，可以验证一下以下情况是否正常。</p>
<ol type="1">
<li>浏览器中使用ip访问：重定向到<a href="https://tdom.ml" class="uri" target="_blank" rel="noopener">https://tdom.ml</a>;</li>
<li>浏览器中使用<a href="https://ip" class="uri" target="_blank" rel="noopener">https://ip</a>访问：重定向到<a href="https://tdom.ml" class="uri" target="_blank" rel="noopener">https://tdom.ml</a>(跳转的时候浏览器可能提示不安全是正常的);</li>
<li>浏览器中使用<a href="tdom.ml" class="uri">tdom.ml</a>访问：重定向到<a href="https://tdom.ml" class="uri" target="_blank" rel="noopener">https://tdom.ml</a>。</li>
</ol>
<h4 id="启动bbr可选建议">启动bbr（可选，建议）</h4>
<p>启动bbr需要Linux内核版本在4.10及以上，如果低于该版本需要自己升级（这不在本教程范围之后）内核版本，保证内核版本不低于4.10。查看系统内核版本命令如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>
<p>bbr是谷歌开发的网络控制算法，可以加快访问速度。执行下面命令查看当前系统是否启用bbr。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl net.ipv4.tcp_congestion_control</span><br></pre></td></tr></table></figure>
<p>执行完成之后如果<strong><em>提示<code>net.ipv4.tcp_congestion_control = bbr</code></em></strong>即表示启动了bbr，可以跳过下面启动bbr的步骤。</p>
<p>直接将下面三条命令拷贝粘贴到Xshell里面执行即可启动bbr，检查启动状态同上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="string">'echo "net.core.default_qdisc=fq" &gt;&gt; /etc/sysctl.conf'</span></span><br><span class="line">sudo bash -c <span class="string">'echo "net.ipv4.tcp_congestion_control=bbr" &gt;&gt; /etc/sysctl.conf'</span></span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>
<h4 id="配置防火墙可选">配置防火墙（可选）</h4>
<p>只打开22、80和443端口可以有效的阻止外部恶意流量，降低服务器暴露的风险。此步骤非必须，而且自己有其他服务记得其他服务的端口也要处理。</p>
<p>本文以ufw为例配置防火墙，ufw是一个很好用的防火墙配置命令，可以简化操作，减少错误的发生。</p>
<p><strong><em>Debian or Ubuntu</em></strong>执行如下命令安装ufw</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y ufw</span><br></pre></td></tr></table></figure>
<p><strong><em>CentOS</em></strong>执行如下两个命令安装ufw</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y epel-release</span><br><span class="line">sudo yum install -y ufw</span><br></pre></td></tr></table></figure>
<p>如果服务器无IPv6地址那么需要执行如下命令，将IPV6=yes修改为IPV6=no。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/default/ufw</span><br></pre></td></tr></table></figure>
<p>执行如下命令即可成功配置防火墙。注意，如果ssh端口不是22那么第一行需要调整（将ssh改为端口号）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw <span class="built_in">disable</span></span><br><span class="line">sudo ufw allow ssh</span><br><span class="line">sudo ufw allow https</span><br><span class="line">sudo ufw allow http</span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw status</span><br><span class="line">sudo ufw status verbose</span><br></pre></td></tr></table></figure>
<p>另外，如果对Trojan不放心，那么可以参考<a href="https://github.com/trojan-gfw/trojan/wiki/Limiting-Server-Network-Access" target="_blank" rel="noopener">trojan wiki</a>，优化防火墙配置，使得Trojan只能给127.0.0.1:80发送数据和响应外部请求。</p>
<h3 id="windows或mac客户端部署">Windows或Mac客户端部署</h3>
<p>几点说明，目前客户端Trojan不能使用全局代理，所以需要配合其他软件使用，比如proxifier等。推荐使用Trojan+Chrome插件SwitchyOmega实现只能Chrome翻墙的目的。这样Trojan只用监听一个端口，由Chrome插件决定当前流量是否走代理。如果你有别的用途可以单独在某个软件内部使用SOCKS5协议指定代理，地址为Trojan的地址：127.0.0.1:1080。</p>
<h4 id="配置windows客户端">配置Windows客户端</h4>
<p>Windows客户端下载地址<a href="https://github.com/trojan-gfw/trojan/releases" target="_blank" rel="noopener">Trojan for Windows</a>，打开之后下载最新版本的win.zip压缩包。</p>
<p>下载成功之后解压，修改目录中的<code>config.json</code>配置文件中的<code>local_port</code>、<code>remote_addr</code>和<code>password</code>即可。其中，<code>remote_addr</code>填写自己的域名，<code>local_port</code>开启本地端口，用来接收本地数据，建议修改为不常用端口，否则容易冲突，本文仅使用默认端口1080演示。Trojan不需要安装就可以直接运行，拷贝Trojan文件夹到电脑里面，双击即可运行。如果启动报错，那么说明你的系统里面没有C++运行环境，需要安装<a href="https://support.microsoft.com/en-us/help/2977003/the-latest-supported-visual-c-downloads" target="_blank" rel="noopener">VC++运行环境</a>（1.12.3及以前版本安装x86环境，1.13.0及以后版本安装x64环境，或者两个版本都安装也行），然后重新启动Trojan，确认Trojan没有报错即可。如果启动Trojan会一闪而过，那么应该是你配置文件有错误，请仔细检查。可以使用控制台运行Trojan，能看到具体是哪一行有错，具体方法：使用命令提示符在Trojan目录运行<code>trojan</code>命令可以看到具体哪一行错误，如果出现<code>fatal: config.json(n): invalid code sequence</code>错误，那么是你的配置文件第<code>n</code>行有错误，请检查。</p>
<p><strong><em>如何配置图形界面：</em></strong>Trojan的Windows客户端目前还没有图形界面，如果对黑框有强迫症，可以使用<a href="https://github.com/rexdf/CommandTrayHost/releases" target="_blank" rel="noopener">CommandTrayHost</a>将黑框托盘化。这是本人目前采用的方案，相关文件可以在<a href="https://github.com/trojan-tutor/VPN/releases" target="_blank" rel="noopener">这里下载</a>，下载完成之后解压并将你的配置文件拷贝到Trojan目录即可使用。</p>
<h4 id="配置mac客户端">配置Mac客户端</h4>
<p>Mac客户端下载地址<a href="https://github.com/trojan-gfw/trojan/releases" target="_blank" rel="noopener">Trojan for Mac</a>，打开之后下载最新版的macos.zip，编辑配置文件同Windows客户端，编辑好配置文件后双击运行<code>start.command</code>即可。如果出现<code>bind: Permission denied</code>错误，需要在终端使用<code>killall trojan</code>命令杀掉现有的Trojan相关的进程。如果出现<code>fatal: config.json(n): invalid code sequence</code>错误，那么是你的配置文件第<code>n</code>行有错误，请检查。</p>
<h4 id="安装chrome">安装Chrome</h4>
<p>如果没有安装Chrome需要先安装一下<a href="https://www.google.cn/chrome/" target="_blank" rel="noopener">Chrome</a>。</p>
<h4 id="确认服务器可达">确认服务器可达</h4>
<p><strong><em>在Chrome浏览器中访问你自己的网站，确保服务器可达。</em></strong>这一步在每一台Windows的客户端都必须做，否则有可能会连接服务器失败（Trojan日志显示握手失败），这是Windows系统的问题（或者说是bug吧）。</p>
<h4 id="以socks5方式启动chrome">以SOCKS5方式启动Chrome</h4>
<p>只需要这一次以SOCKS5启动Chrome，配置完成之后正常使用即可。</p>
<h5 id="windows">Windows</h5>
<p>在命令提示符（搜索框输入cmd）输入下面的命令启动Chrome，注意端口号如果你有修改也要对应的修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start C:\<span class="string">"Program Files (x86)"</span>\Google\Chrome\Application\chrome.exe --proxy-server=<span class="string">"socks5://127.0.0.1:1080"</span> --host-resolver-rules=<span class="string">"MAP * ~NOTFOUND, EXCLUDE 127.0.0.1"</span></span><br></pre></td></tr></table></figure>
<p><strong><em>如果上述命令无法启动Chrome，是因为新版本的Chrome更改了安装路径导致的，你需要更新你的Chrome版本啦。</em></strong></p>
<h5 id="mac">Mac</h5>
<p>在终端输入下面的命令启动Chrome，注意端口号如果你有修改也要对应的修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --proxy-server=<span class="string">"socks5://127.0.0.1:1080"</span> --host-resolver-rules=<span class="string">"MAP * ~NOTFOUND, EXCLUDE 127.0.0.1"</span></span><br></pre></td></tr></table></figure>
<h4 id="安装switchyomega插件">安装SwitchyOmega插件</h4>
<p>访问<a href="https://chrome.google.com/webstore/category/extensions?hl=zh-CN" target="_blank" rel="noopener">Chrome网上应用店</a>，搜索SwitchyOmega即可找到SwitchyOmega插件并安装之。安装完成之后重启Chrome。</p>
<h4 id="配置switchyomega插件以下每一步配置完之后记得应用选项">配置SwitchyOmega插件（以下每一步配置完之后记得应用选项）</h4>
<p>在Chrome右上角打开SwitchyOmega配置界面，如图所示： <img src="p41/SwitchyOmega选项.jpg" alt="SwitchyOmega选项"></p>
<p>情景模式中的auto switch配置如图所示：注意规则列表规则选择proxy，规则列表格式为AutoProxy，其网址为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt</span><br></pre></td></tr></table></figure>
<p>填写完成之后需要先更新情景模式使其生效，如图所示： <img src="p41/autoSwitch.jpg" alt="autoSwitch"></p>
<p>情景模式中的proxy配置如下图所示，其中代理协议选择SOCKS5，这是Trojan支持的协议，注意不要选错了，127.0.0.1:1080为Trojan代理地址，只有流向这个地址的流量Trojan才会处理，如果Trojan配置文件有修改本地端口号这里也得对应的修改。 <img src="p41/proxy.jpg" alt="proxy"></p>
<p>设定中的初始情景模式选择auto switch，如图所示。这样当检测到目标地址在GFW列表中的时候Chrome会让其走Trojan代理。否则直连。 <img src="p41/初始情景模式.jpg" alt="初始情景模式"></p>
<p>然后重启Chrome，保证SwitchyOmega运行在auto switch模式，否则可能无法正常使用，常见现象有无法访问国外网站、导致访问国内网站速度变慢或无法访问内网等。如图所示： <img src="p41/确定状态.jpg" alt="确定状态"></p>
<p>至此客户端Trojan已经配置完成，尽情享受吧！！！</p>
<h3 id="其他客户端部署指南">其他客户端部署指南</h3>
<p>Linux客户端：Linux客户端安装方式与服务端一样，配置文件参考客户端修改即可；</p>
<p>IOS客户端：美区ID+[<a href="https://apps.apple.com/app/pharos-pro/id1456610173" target="_blank" rel="noopener">Pharos Pro</a> | <a href="https://apps.apple.com/us/app/shadowrocket/id932747118" target="_blank" rel="noopener">Shadowrocket</a>];</p>
<p>Android客户端：<a href="https://github.com/trojan-gfw/igniter/releases" target="_blank" rel="noopener">igniter</a>，已经支持分流。</p>
<h3 id="fqa">FQA</h3>
<p>浏览器报错<code>ERR_SSL_PROTOCOL_ERROR</code>：可能是系统问题，解决方案是删除配置文件中的<code>alpn</code>中的<code>h2</code>那一行，或者重装系统。</p>
<h3 id="如何寻求帮助">如何寻求帮助</h3>
<ol type="1">
<li>仔细核对操作是否与本文一致，特别是我加粗的地方很容易出错。</li>
<li>去<a href="https://github.com/trojan-gfw/trojan/issues?utf8=%E2%9C%93&amp;q=is%3Aissue" target="_blank" rel="noopener">Trojan-GFW</a>项目查找是否有类似issue，如果有类似issue可自行参考解决。如果没有类似issue也可以在那里提交新的issue，基本上都会得到回复。</li>
<li>去<a href="https://github.com/trojan-gfw" target="_blank" rel="noopener">Trojan-GFW</a>官方电报群请教群里的开发者和大佬们：<a href="https://t.me/trojangfw" target="_blank" rel="noopener">trojan-gfw</a>。群里的人都是比较专业的，你的问题基本都能被解决，请注意群规和礼貌。</li>
<li>在博客<a href="https://github.com/trojan-tutor/trojan-tutor.github.io/issues?utf8=%E2%9C%93&amp;q=is%3Aissue" target="_blank" rel="noopener">留言区</a>留言，我有空便会回复（但是肯定没有 1 和 2 方便和及时），记得带上服务端和客户端日志还有浏览器提示一起！</li>
</ol>
<h3 id="进阶">进阶</h3>
<p>Trojan-GFW项目提供了用户管理界面，可以很方便的添加、删除用户和为每个用户设置流量限制，配置教程：<a href="/2019/06/08/p43.html">Trojan-Panel配置</a>。</p>

      
    </div>

    

    
      
    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/VPN/" rel="tag"># VPN</a>
          
            <a href="/tags/科学上网/" rel="tag"># 科学上网</a>
          
            <a href="/tags/代理工具/" rel="tag"># 代理工具</a>
          
            <a href="/tags/GFW/" rel="tag"># GFW</a>
          
            <a href="/tags/翻墙/" rel="tag"># 翻墙</a>
          
            <a href="/tags/vps/" rel="tag"># vps</a>
          
            <a href="/tags/Ubuntu/" rel="tag"># Ubuntu</a>
          
            <a href="/tags/Debian/" rel="tag"># Debian</a>
          
            <a href="/tags/vultr/" rel="tag"># vultr</a>
          
            <a href="/tags/服务器/" rel="tag"># 服务器</a>
          
            <a href="/tags/Trojan/" rel="tag"># Trojan</a>
          
            <a href="/tags/Trojan-GFW/" rel="tag"># Trojan-GFW</a>
          
            <a href="/tags/Trojan-quickstart/" rel="tag"># Trojan-quickstart</a>
          
            <a href="/tags/https伪装/" rel="tag"># https伪装</a>
          
            <a href="/tags/Nginx/" rel="tag"># Nginx</a>
          
            <a href="/tags/bash/" rel="tag"># bash</a>
          
            <a href="/tags/小白教程/" rel="tag"># 小白教程</a>
          
            <a href="/tags/搭建教程/" rel="tag"># 搭建教程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/08/p43.html" rel="prev" title="Trojan-Panel配置">
                Trojan-Panel配置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">trojan-tutor</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/index.html">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
        
        
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>













          
          
        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#综述"><span class="nav-number">1.</span> <span class="nav-text">综述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本文简介"><span class="nav-number">1.1.</span> <span class="nav-text">本文简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#trojan工作原理浅析"><span class="nav-number">1.2.</span> <span class="nav-text">Trojan工作原理浅析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前置条件"><span class="nav-number">2.</span> <span class="nav-text">前置条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vps服务器购买"><span class="nav-number">3.</span> <span class="nav-text">VPS服务器购买</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注册vultr"><span class="nav-number">3.1.</span> <span class="nav-text">注册vultr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#充值"><span class="nav-number">3.2.</span> <span class="nav-text">充值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#购买服务器"><span class="nav-number">3.3.</span> <span class="nav-text">购买服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务器信息查看"><span class="nav-number">3.4.</span> <span class="nav-text">服务器信息查看</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#域名申请与解析"><span class="nav-number">4.</span> <span class="nav-text">域名申请与解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#freenom免费域名申请"><span class="nav-number">4.1.</span> <span class="nav-text">freenom免费域名申请</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注册cloudflare"><span class="nav-number">4.2.</span> <span class="nav-text">注册cloudflare</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vps服务器部署"><span class="nav-number">5.</span> <span class="nav-text">VPS服务器部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#远程工具安装"><span class="nav-number">5.1.</span> <span class="nav-text">远程工具安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接服务器"><span class="nav-number">5.2.</span> <span class="nav-text">连接服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建用户账户可选"><span class="nav-number">5.3.</span> <span class="nav-text">创建用户账户（可选）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建服务账户"><span class="nav-number">5.4.</span> <span class="nav-text">创建服务账户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装依赖"><span class="nav-number">5.5.</span> <span class="nav-text">安装依赖</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ubuntu-or-debian"><span class="nav-number">5.5.1.</span> <span class="nav-text">Ubuntu or Debian</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#centos"><span class="nav-number">5.5.2.</span> <span class="nav-text">CentOS</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建证书文件夹"><span class="nav-number">5.6.</span> <span class="nav-text">创建证书文件夹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置证书"><span class="nav-number">5.7.</span> <span class="nav-text">配置证书</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安装acme.sh自动管理ca证书脚本"><span class="nav-number">5.7.1.</span> <span class="nav-text">安装acme.sh自动管理CA证书脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#添加cloudflare-global-ca-key"><span class="nav-number">5.7.2.</span> <span class="nav-text">添加cloudflare Global CA Key</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#申请证书"><span class="nav-number">5.7.3.</span> <span class="nav-text">申请证书</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装证书"><span class="nav-number">5.7.4.</span> <span class="nav-text">安装证书</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改权限"><span class="nav-number">5.7.5.</span> <span class="nav-text">修改权限</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置trojan"><span class="nav-number">5.8.</span> <span class="nav-text">配置Trojan</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安装trojan"><span class="nav-number">5.8.1.</span> <span class="nav-text">安装Trojan</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动trojan"><span class="nav-number">5.8.2.</span> <span class="nav-text">启动Trojan</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#修改trojan启动用户"><span class="nav-number">5.8.2.1.</span> <span class="nav-text">修改Trojan启动用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#赋予trojan监听443端口能力"><span class="nav-number">5.8.2.2.</span> <span class="nav-text">赋予Trojan监听443端口能力</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#使用systemd启动trojan"><span class="nav-number">5.8.2.3.</span> <span class="nav-text">使用systemd启动Trojan</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#更新证书"><span class="nav-number">5.8.3.</span> <span class="nav-text">更新证书</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#更新trojan"><span class="nav-number">5.8.4.</span> <span class="nav-text">更新Trojan</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置nginx"><span class="nav-number">5.9.</span> <span class="nav-text">配置Nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#写入虚拟主机到nginx配置文件"><span class="nav-number">5.9.1.</span> <span class="nav-text">写入虚拟主机到Nginx配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#centos-1"><span class="nav-number">5.9.1.1.</span> <span class="nav-text">CentOS</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ubuntu-or-debian-1"><span class="nav-number">5.9.1.2.</span> <span class="nav-text">Ubuntu or Debian</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#写入配置"><span class="nav-number">5.9.1.3.</span> <span class="nav-text">写入配置</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动nginx"><span class="nav-number">5.9.2.</span> <span class="nav-text">启动Nginx</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#与现有nginx服务集成"><span class="nav-number">5.9.3.</span> <span class="nav-text">与现有Nginx服务集成</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置trojan和nginx开机自启"><span class="nav-number">5.10.</span> <span class="nav-text">配置Trojan和Nginx开机自启</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查服务器是否配置成功"><span class="nav-number">5.11.</span> <span class="nav-text">检查服务器是否配置成功</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动bbr可选建议"><span class="nav-number">5.12.</span> <span class="nav-text">启动bbr（可选，建议）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置防火墙可选"><span class="nav-number">5.13.</span> <span class="nav-text">配置防火墙（可选）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#windows或mac客户端部署"><span class="nav-number">6.</span> <span class="nav-text">Windows或Mac客户端部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置windows客户端"><span class="nav-number">6.1.</span> <span class="nav-text">配置Windows客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置mac客户端"><span class="nav-number">6.2.</span> <span class="nav-text">配置Mac客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装chrome"><span class="nav-number">6.3.</span> <span class="nav-text">安装Chrome</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#确认服务器可达"><span class="nav-number">6.4.</span> <span class="nav-text">确认服务器可达</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#以socks5方式启动chrome"><span class="nav-number">6.5.</span> <span class="nav-text">以SOCKS5方式启动Chrome</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#windows"><span class="nav-number">6.5.1.</span> <span class="nav-text">Windows</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mac"><span class="nav-number">6.5.2.</span> <span class="nav-text">Mac</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装switchyomega插件"><span class="nav-number">6.6.</span> <span class="nav-text">安装SwitchyOmega插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置switchyomega插件以下每一步配置完之后记得应用选项"><span class="nav-number">6.7.</span> <span class="nav-text">配置SwitchyOmega插件（以下每一步配置完之后记得应用选项）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他客户端部署指南"><span class="nav-number">7.</span> <span class="nav-text">其他客户端部署指南</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fqa"><span class="nav-number">8.</span> <span class="nav-text">FQA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何寻求帮助"><span class="nav-number">9.</span> <span class="nav-text">如何寻求帮助</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进阶"><span class="nav-number">10.</span> <span class="nav-text">进阶</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">trojan-tutor</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.2.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  





  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>









  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  

  

  


  

</body>
</html>
